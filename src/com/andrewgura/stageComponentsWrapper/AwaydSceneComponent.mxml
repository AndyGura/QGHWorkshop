<?xml version="1.0"?>
<stagecomponentswrapper:StageComponent xmlns:fx="http://ns.adobe.com/mxml/2009"
                                       xmlns:stagecomponentswrapper="com.andrewgura.stageComponentsWrapper.*"
                                       xmlns:mx="library://ns.adobe.com/flex/mx" addedToStage="onAddedToStage(event)">

    <fx:Script><![CDATA[
        import away3d.containers.Scene3D;
        import away3d.containers.View3D;

        import mx.events.FlexEvent;

        private var _view:View3D;
        private var _scene:Scene3D;
        private var isAddedToStage:Boolean = false;


        [Bindable(event="sceneChanged")]
        public function get scene():Scene3D {
            return _scene;
        }

        public function set scene(value:Scene3D):void {
            if (_scene == value) return;
            _scene = value;
            if (isAddedToStage) {
                updateAway3dScene();
            }
            dispatchEvent(new Event("sceneChanged"));
        }

        override protected function onResizeWithDelay():void {
            super.onResizeWithDelay();
            _view.width = this.width;
            _view.height = this.height;
        }

        private function onAddedToStage(event:Event):void {
            addEventListener(Event.ENTER_FRAME, _onEnterFrame);
            isAddedToStage = true;
            updateMask();
            setupParents();
            if (isGloballyVisible()) {
                setMask();
                isShow = true;
                visibleStarlingComponentsCount++;
                if (visibleStarlingComponentsCount == 1) {
                    onStageResized();
                }
            }
            if (_scene) {
                updateAway3dScene();
            }
        }

        private function _onEnterFrame(e:Event):void {
            if (_scene.numChildren > 0) {
                _scene.getChildAt(0).rotationY += 0.5;
                _scene.getChildAt(0).rotationY += 0.5;
            }
            _view.render();
        }

        private function updateAway3dScene():void {
            if (!_view) {
                _view = new View3D();
                _view.width = this.width;
                _view.height = this.height;
                uiComponent.addChild(_view);
                _view.camera.z = -800;
                _view.camera.y = 500;
                _view.camera.lookAt(new Vector3D());
            }
            _view.scene = _scene;
        }


        override protected function hideShowHandler(event:FlexEvent):void {
            super.hideShowHandler(event);
            updateAway3dScene();
        }
        ]]>
    </fx:Script>

    <mx:UIComponent width="100%" height="100%" id="uiComponent"/>

</stagecomponentswrapper:StageComponent>
